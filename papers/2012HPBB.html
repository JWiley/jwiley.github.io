<!DOCTYPE html>

<meta charset="utf-8">

<title>An Integrative Approach to Psychosocial Resources and Health</title>

<section>
  <h1>An Integrative Approach to Psychosocial Resources and Health</h1>
  <span style="float:left; padding-top: 160px; font-size: small;">
  Slides: <a href="http://joshuawiley.com/papers/2012HPBB.html">
  http://joshuawiley.com/papers/2012HPBB.html</a>
</span>

  <footer>Joshua F. Wiley</footer>
</section>

<section>
  <h3>Psychosocial Resources</h3>
  <ul>
    <li>Taylor & Broffman define psychosocial resources (PSRs) as
    "individual differences and social relationships that have
    beneficial effects on mental and physical health outcomes" <br /></li>
  
    <li>Resources are a broad construct that can include many specific
    resources<br /></li>
  
    <li>Current literature often focuses on individual resources
    (e.g., optimism) or one specific set.</li>
  </ul>
  <details>I am focusing on PSRs as positive characteristics,
  consequently do not include constructs like neuroticism. Individual
  differences can be traits, so primarily stable, but not
  necessarily. Contextually specific and more state measures may also
  be resources. To the extent that personality or traits represent
  average or aggregate response tendencies, we can think of them as a
  combination of many contextually specific, state, tendencies or
  responses amalgamated over time.
  </details>
</section>

<section>
  <h3>Questions</h3>
  <ul  class="incremental">
    <li>How do resources
    and <em>changes</em> in resources relate to health-relevant
    outcomes?</li>
    <li>Are there broad resources
      constructs such as psychological or social resources? If so, are 
      they sensitive or robust to the specific questionnaires used?</li>
    <li>Do latent psychological and social resources constructs
    predict the same outcomes as individual resources?</li>
  </ul>
</section>

<section>
  <h3>Overview</h3>
  <ul class="incremental">
    <li>Study 1: Changes in self-efficacy and outcome expectancies over treatment predict psychological health trajectories</li>
    <li>Study 2: Transactional and indirect effects of social support, anxiety, and depressive symptoms</li>
    <li>Study 3: PSR factor structure, validity and value</li>
    <li>Study 4: Validation of PSR factor structure and prediction</li>
  </ul>
</section>

<section>
  <h2>Study 1</h2>
</section>

<section>
  <h3>Methods</h3>
  <ul>
    <li>Coordinated Anxiety Learning and Management (CALM) multi-site
    RCT</li>
    <li>Patients with a principal anxiety disorder were randomized to
    usual care (N = 501) or CALM (N = 503)</li>
    <li>Study 1 focused on those randomized to 
    the intervention who completed at least one treatment
    session (N = 482).</li>
    <li>Predictors assessed at start of every treatment session, 
    outcomes assessed at 0, 6, 12, &amp; 18 months</li>
  </ul>
  <details>We heard a little bit about this study earlier this quarter from Andrea</details>
</section>

<section>
  <h3>Outcomes</h3>
  <ul class="incremental">
    <li><strong>Anxiety Sensitivity Index</strong> (ASI):  beliefs that anxiety is harmful</li>
    <li><strong>Brief Symptom Inventory</strong> (BSI): somatization and
    anxiety symptoms</li>
    <li><strong>Patient Health Questionnaire</strong> (PHQ): depressive symptoms excluding suicidality</li>
    <li><strong>Sheehan Disability Scale</strong> (SDS): functional impairment</li>    
  </ul>
  <details>ASI, 16 items; BSI, 12 items; PHQ, 8 items; SDS, 3 items.</details>
</section>

<section>
  <h3>Predictors</h3>
  <ul class="incremental">
    <li><strong>Outcome Expectancy</strong> (OE):<br /> "How likely is it that your anxiety can be successfully treated?"</li>
    <li><strong>Self Efficacy</strong> (SE):<br /> "How likely is it you will be able to do what is necessary to make your anxiety treatment successful?"</li>
  </ul>
  <details>One can think of these as more state measures, of
  contextually specific dispositional optimism and mastery, respectively.</details>
</section>

<section>
  <strong>Conceptual Model</strong><br /><br />
      <div style="width: 800px; height: 520px;"><img src="seoe_graphs.png"></div>
  <details></details>
</section>

<section>
      <img src="asi_growth.svg">
  <details>Participants averaged 43.5 years, were primarily white
  (69.6%) and female (71.1%). Anxiety Symptoms Growth Model
  </details>
</section>

<section>
  <strong>Self Efficacy</strong>
      <img src="seall_growth.svg">
  <details>Parallel Model SE</details>
</section>

<section>
  <strong>Outcome Expectancy</strong>
      <img src="oeall_growth.svg">  
  <details>Parallel Model OE</details>
</section>

<section>
  <h3>Conclusions</h3>
  <ul>
    <li>Absolute levels of SE and OE predict symptom trajectories</li>
    <li><em>Change</em> in SE and OE during treatment uniquely
    predicts changes in symptoms beyond <em>actual</em> SE and OE levels</li>
  </ul>
  <details>These conclusions <em>could not</em> be made without a sophisticated study design including treatment-relevant variables measured throughout treatment, longitudinal follow-up of outcomes, and a sufficient sample size for adequate power and a stable model</details>
</section>

<section>
  <iframe src='https://joshuawiley.com/statistics/plgm.html'
  width="100%" height="100%" style="background: white;"></iframe>
</section>


<section>
  <h2>Study 2</h2>
</section>

<section>
  <h3>Methods</h3>
  <ul>
    <li>Again using the CALM Study</li>
    <li>Included subjects (N = 1004) from both the usual care (n = 501) and CALM (n = 503) arms</li>
    <li>Participants assessed at baseline, 6, 12, &amp; 18 months</li>
  </ul>
</section>

<section>
  <h3>Measures</h3>
  <ul>
    <li>Intervention: 0 = usual care, 1 = CALM</li>
    <li>BSI and PHQ as before</li>
    <li>Medical Outcomes Study Social Support Survey (SS): 4 item abbreviated scale</li>
    <li>Age (older than 55 0/1), Sex (female/male), Ethnicity (groups) were examined as moderators</li>
  </ul>
</section>

<section>
      <img src="mediationmodel.svg">
  <details>Transactional and mediation model, direct effects</details>
</section>

<section>
  <strong>Indirect Effect on 18-month Anxiety Symptoms</strong>
      <img src="ind1.svg">
  <details></details>
</section>
<section>
  <strong>Indirect Effect on 18-month Depressive Symptoms</strong>
      <img src="ind2.svg">
  <details></details>
</section>
<section>
  <strong>Indirect Effect on 18-month Social Support via Anxiety Symptoms</strong>
      <img src="ind3.svg">
  <details></details>
</section>
<section>
  <strong>Indirect Effect on 18-month Social Support via Depressive Sxs</strong>
      <img src="ind4.svg">
  <details></details>
</section>

<section>
  <h3>Conclusions</h3>
  <ul>
    <li>No moderation by age, sex, or ethnicity on indirect effects</li>
    <li>Social support mediated effects on anxiety (BSI) and depressive symptoms (PHQ)</li>
    <li>Depressive symptoms mediated effects on social support</li>
    <li>Transactional effects between depressive symptoms and social support</li>
  </ul>
  <details>Sophisticated design and large sample allow examination of transactional effects and mediation over time</details>
</section>

<section>
  <iframe src='https://joshuawiley.com/statistics/medanal.html'
  width="100%" height="100%" style="background: white;"></iframe>
</section>

<section>
  <h2>Study 3</h2>
</section>

<section>
  <h3>Methods</h3>
  <ul>
    <li>Participants (N = 99) were individuals treated for choroidal melanoma, a cancer of the eye</li>
    <li>Retrospectively recruited using medical records from patients at the Jules Stein Eye Institute</li>
    <li>Cross-sectional study on a rare population using self-report questionnaires</li>
  </ul>
</section>

<section>
  <h3>Psychosocial Resources</h3>
  <ul>
    <li><strong>Life Orientation Test Revised</strong>: dispositional optimism (3 items) and low pessimism (3 items)</li>
    <li><strong>Hope</strong>: belief one has the ability to reach and can find ways to achieve goals (8 items)</li>
    <li><strong>Mastery</strong>: dispositional personal control or self-efficacy (7 items)</li>
    <li><strong>Social Support</strong> (from the Medical Outcomes Study): <br/>
        <em>tangible</em> (4 items), <em>affectionate</em> (3 items), <br/>
        <em>positive interaction</em> (3 items), <em>emotional</em> (8 items)</li>
  </ul>
</section>

<section>
  <h3>Psychological Health Measures</h3>
  <ul>
    <li><strong>Center for Epidemiologic Studies Depression Scale</strong>: standard measure of depressive symptoms (20 items)</li>
    <li><strong>SF-36 Mental Component Summary</strong> (MCS): mental health-related quality of life, composite of many subscales with orthogonal weights</li>
  </ul>
  <details>orthogonal weighting for those who heard Andrea's talk</details>
</section>

<section>
  <strong>One or two factors?</strong>
      <img src="roms_measurement.svg">
  <details></details>
</section>

<section>
  <strong>Two Factor Model</strong>
      <img src="roms_twofactormm.svg">
  <details></details>
</section>

<section>
  <strong>PSR Factors and Psychological Health</strong>
      <img src="roms_sem.svg">
  <details></details>
</section>

<section>
  <h3>Conclusions</h3>
  <ul>
    <li>Optimism, hope, mastery, and social support, map well onto psychological and social resource factors</li>
    <li>Psychological and social resources are strongly associated with depressive symptoms and mental health-related quality of life</li>
    <li>Working with aggregate constructs is sufficient and simplifies focal relationships</li>
  </ul>
</section>

<section>
  <h2>Study 4</h2>
  <details>I know, shocking I did not have a general introduction to latent variable models ;)</details>
</section>

<section>
  <h3>Methods</h3>
  <ul>
    <li>Project Connect RCT of an internet-based intervention</li>
    <li>Women (N = 88) undergoing or finished with medical treatment for breast cancer were recruited from a community practice</li>
    <li>Psychosocial resources were assessed at baseline, psychological health measures were assessed at baseline and 6 month follow-up</li>
  </ul>
</section>

<section>
  <h3>Psychosocial Resources</h3>
  <ul>
    <li><strong>Life Orientation Test Revised</strong>: dispositional optimism (3 items) and low pessimism (3 items)</li>
    <li><strong>Carver Sources of Social Support</strong>: using the emotional, 
	informational and instrumental domains each averaged across perceived support 
	from partners, family, and friends</li>
    <li><strong>Sarason Social Support Questionnaire</strong>: the number of people providing support 
        and satisfaction with support averaging across domains for both number and satisfaction</li>
  </ul>
</section>

<section>
  <h3>Psychological Health Measures</h3>
  Assessed at baseline and 6 months
  <ul>
    <li><strong>Center for Epidemiologic Studies Depression Scale</strong>: standard measure of depressive symptoms (20 items)</li>
    <li><strong>Satisfaction with Life Scale</strong>: five item measure of life satisfaction</li>
  </ul>
</section>

<section>
  <strong>Two Factor Model</strong>
      <img src="pc_twofactormm.svg">
  <details></details>
</section>

<section>
  <strong>PSR Factors and Psychological Health</strong>
      <img src="pc_sem.svg">
  <details></details>
</section>

<section>
  <strong>Predicting Psychological Health</strong>
      <img src="pc_lsem.svg" >
  <details></details>
</section>

<section>
  <h3>Conclusions</h3>
  <ul>
    <li>Optimism, and multiple domains of social support, fit the same basic structure as in Study 3</li>
    <li>PSRs (optimism and social resources) are associated with depressive symptoms and life satisfaction</li>
    <li>PSRs predict increases in life satisfaction, but not decreases in depressive symptoms</li>
  </ul>
</section>

<section>
  <h2>Conclusions</h2>
</section>

<section>
  <ul>
    <li>Self-efficacy and outcome expectancies predict psychological health trajectories</li>
    <li><em>Change</em> in these resources predict psychological health up to a year following treatment over and above the effect of their absolute level</li>
    <li>Resources are not immutable. Social support and depressive symptoms have a bidirectional relationship</li>
  </ul>
  <details>Notes.</details>
</section>

<section>
  <ul>
    <li>A two factor model of psychological and social resources provide good fit for optimism, mastery, hope, and social support in two cancer populations</li>
    <li>These factors are strongly associated with psychological health and predict <em>change</em> in life satisfaction</li>
    <li>Reality is complex. Studies integrating multiple domains, time, or both provide insight that is difficult to
    obtain via many small, focused studies.</li>
  </ul>
  <details>Notes.</details>
</section>

<section>
  <h3>Remaining Questions</h3>
  <ul class="incremental">
    <li>Do results generalize (e.g., other ages and cultures)?</li>
    <li>Are resources relevant outside of disease contexts?</li>
    <li>Are resources related to biology and hard health outcomes?</li>
  </ul>
  <details>
  No moderation by age in CALM of specific pathways.  Studies I am planning for my dissertation examine job and neighborhood environment as potential exogenous stressors, as well as looking at whether resources predict inflammation and HPA axis in the Midlife Development in the United States (MIDUS) study.
  </details>
</section>    

<section>
  <blockquote>
    Good point that testing BPS model in a single study is
    challenging. Interesting that you don’t say
    impossible.</blockquote>
  <footer style="text-align:left"><a href="http://joshuawiley.com/coursework/cexam.aspx">Rater 2</a>
  (2012 HP Comprehensive Exam, Question 1)</footer>
  <details>Not only is it not impossible, I believe we can do this <em>now</em>!</details>
</section>

<!--
<section>
    <figure>
      <img src="http://placekitten.com/g/800/600">
      <figcaption>An image</figcaption>
    </figure>
    <details>Kittens are so cute!</details>
</section>

<section>
    <figure>
      <video src="http://videos-cdn.mozilla.net/brand/Mozilla_Firefox_Manifesto_v0.2_640.webm" poster="http://www.mozilla.org/images/about/poster.jpg"></video>
      <figcaption>A video</figcaption>
    </figure>
</section>
-->

<section>
  <h3>Thanks</h3>
  <ul class="incremental">
    <li>Lily Brown, Halina Dour, Annette Stanton</li>
    <li>Elizabeth Thompson, Tammy Beran, Tara McCannel </br>
        Stanton Lab, Craske Lab, CALM Team</li>
    <li>Psych first year fellowship</br>
        UCLA GSRM</br>
        NIGMS traineeship, T32GM084903</br>
        UCLA Institute for Digital Research and Education</li>
    <li>You</li>
  </ul>
</section>

<section>
  <h3>References</h3>
  <ul style="font-size: medium">
    <li>Brown, L. A., <strong>Wiley, J. F.</strong>, CALM Team, &amp; Craske,
    M. (submitted for review). <i>Changes in self-efficacy and
    outcome expectancy as predictors of anxiety outcomes from the CALM
    study</i>.
    <li>Dour, H. J., <strong>Wiley, J. F.</strong>, CALM Team, &amp; Craske, M.
    (submitted for review). <i>Social Support Mediates Anxiety and Depressive 
    Symptom Changes Following Primary Care Intervention</i>.
    <li><strong>Wiley, J. F.</strong>, Thompson, E. H., Beran, T. M., &amp; Stanton,
    A. L. (in preparation). <i>Conceptualization and measurement
    of psychosocial resources as a constellation</i>.
    <li><strong>Wiley, J. F.</strong> (2012). <i>How change predicts change: Examples
    of parallel latent growth models</i>. Technical
    Report. Available from:<br />
    <a href="http://joshuawiley.com/statistics/plgm.html">
    https//joshuawiley.com/statistics/parallelgrowth.html</a>
    <li><strong>Wiley, J. F.</strong> (2012). <i>An introduction to
    mediation analysis</i>. Technical Report. Available
    from: <br />
    <a href="http://joshuawiley.com/statistics/medanal.html">
    http://joshuawiley.com/statistics/medanal.html</a>
  </ul>
</section>

<section>
  <h2>Questions?</h2>
  </br>
  <ul>
    <li>Email: <a href="mailto:wileyj@ucla.edu">wileyj@ucla.edu</a></li>
    <li>Web: <a href="http://joshuawiley.com">http://joshuawiley.com</a></li>
    <li>Slides: <a href="http://joshuawiley.com/papers/2012HPBB.html">http://joshuawiley.com/papers/2012HPBB.html</a></li>
  </ul>
</section>

<!-- Your Style -->
<!-- Define the style of your presentation -->

<!-- Maybe a font from http://www.google.com/webfonts ? -->
<link href='http://fonts.googleapis.com/css?family=Open+Sans rel='stylesheet'>

<style>
  html, .view body { background-color: black; counter-reset: slideidx; }
  body, .view section { background-color: black; color: #FFFFF0; border-radius: 12px }
  /* A section is a slide. It's size is 800x600, and this will never change */
  section, .view head > title {
      /* The font from Google */
      font-family: 'Open Sans', arial, serif;
      font-size: 25px;
  }

  .view section:after {
    counter-increment: slideidx;
    content: counter(slideidx, decimal-leading-zero);
    position: absolute; bottom: -80px; right: 100px;
    color: white;
  }

  .view head > title {
    color: white;
    text-align: center;
    margin: 1em 0 1em 0;
  }

  h1 {
    margin-top: 100px;
    text-align: center;
    font-size: 60px;
  }
  h2 {
    margin-top: 200px;
    text-align: center;
    font-size: 50px;
  }
  h3 {
    margin: 100px 0 50px 100px;
  }

  ul {
      margin: 50px 100px 0 25px;
  }

  li {
     margin-bottom: 35px;
     list-style: none;
  }

  p {
    margin: 50px;
  }
  a {
    color: white;
  }

  div.fig {
    background-color: white;
  }

  img {
    background-color: white;
    display: block;
    margin-left: auto;
    margin-right: auto;
    width: 100%;
    height: 100%;
  }

  blockquote {
    height: 100%;
    background-color: black;
    color: white;
    font-size: 40px;
    padding: 50px;
  }
  blockquote:before {
    content: open-quote;
  }
  blockquote:after {
    content: close-quote;
  }

  /* Figures are displayed full-page, with the caption
     on top of the image/video */
  figure {
    background-color: black;
    width: 100%;
    height: 100%;
  }
  figure > * {
    position: absolute;
  }
  figure > img, figure > video {
    width: 100%; height: 100%;
  }
  figcaption {
    margin: 70px;
    font-size: 50px;
  }

  footer {
    position: absolute;
    bottom: 0;
    width: 100%;
    padding: 40px;
    text-align: right;
    color: black;
    background-color: #F3F4F8;
    border-top: 1px solid #CCC;
  }

  /* Transition effect */
  /* Feel free to change the transition effect for original
     animations. See here:
     https://developer.mozilla.org/en/CSS/CSS_transitions
     How to use CSS3 Transitions: */
  section {
    -moz-transition: left 400ms linear 0s;
    -webkit-transition: left 400ms linear 0s;
    -ms-transition: left 400ms linear 0s;
    transition: left 400ms linear 0s;
  }
  .view section {
    -moz-transition: none;
    -webkit-transition: none;
    -ms-transition: none;
    transition: none;
  }

  .view section[aria-selected] {
    border: 5px red solid;
  }

  /* Before */
  section { left: -150%; }
  /* Now */
  section[aria-selected] { left: 0; }
  /* After */
  section[aria-selected] ~ section { left: +150%; }

  /* Incremental elements */

  /* By default, visible */
  .incremental > * { opacity: 1; }

  /* The current item */
  .incremental > *[aria-selected] { opacity: 1; }

  /* The items to-be-selected */
  .incremental > *[aria-selected] ~ * { opacity: 0; }

  /* The progressbar, at the bottom of the slides, show the global
     progress of the presentation. */
  #progress-bar {
    height: 6px;
    background: #AAA;
  }
</style>

<!-- {{{{ dzslides core
#
#
#     __  __  __       .  __   ___  __
#    |  \  / /__` |    | |  \ |__  /__`
#    |__/ /_ .__/ |___ | |__/ |___ .__/ core :€
#
#
# The following block of code is not supposed to be edited.
# But if you want to change the behavior of these slides,
# feel free to hack it!
#
-->

<div id="progress-bar"></div>

<!-- Default Style -->
<style>
  * { margin: 0; padding: 0; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }
  details { display: none; }
  body {
    width: 800px; height: 600px;
    margin-left: -400px; margin-top: -300px;
    position: absolute; top: 50%; left: 50%;
    overflow: hidden;
    display: none;
  }
  .view body {
    position: static;
    margin: 0; padding: 0;
    width: 100%; height: 100%;
    display: inline-block;
    overflow: visible; overflow-x: hidden;
    /* undo Dz.onresize */
    transform: none !important;
    -moz-transform: none !important;
    -webkit-transform: none !important;
    -o-transform: none !important;
    -ms-transform: none !important;
  }
  .view head, .view head > title { display: block }
  section {
    position: absolute;
    pointer-events: none;
    width: 100%; height: 100%;
  }
  .view section {
    pointer-events: auto;
    position: static;
    width: 800px; height: 600px;
    margin: -150px -200px;
    float: left;

    transform: scale(.4);
    -moz-transform: scale(.4);
    -webkit-transform: scale(.4);
    -o-transform: scale(.4);
    -ms-transform: scale(.4);
  }
  .view section > * { pointer-events: none; }
  section[aria-selected] { pointer-events: auto; }
  html { overflow: hidden; }
  html.view { overflow: visible; }
  body.loaded { display: block; }
  .incremental {visibility: hidden; }
  .incremental[active] {visibility: visible; }
  #progress-bar{
    bottom: 0;
    position: absolute;
    -moz-transition: width 400ms linear 0s;
    -webkit-transition: width 400ms linear 0s;
    -ms-transition: width 400ms linear 0s;
    transition: width 400ms linear 0s;
  }
  .view #progress-bar {
    display: none;
  }
</style>

<script>
  var Dz = {
    remoteWindows: [],
    idx: -1,
    step: 0,
    html: null,
    slides: null,
    progressBar : null,
    params: {
      autoplay: "1"
    }
  };

  Dz.init = function() {
    document.body.className = "loaded";
    this.slides = Array.prototype.slice.call($$("body > section"));
    this.progressBar = $("#progress-bar");
    this.html = document.body.parentNode;
    this.setupParams();
    this.onhashchange();
    this.setupTouchEvents();
    this.onresize();
    this.setupView();
  }

  Dz.setupParams = function() {
    var p = window.location.search.substr(1).split('&');
    p.forEach(function(e, i, a) {
      var keyVal = e.split('=');
      Dz.params[keyVal[0]] = decodeURIComponent(keyVal[1]);
    });
  // Specific params handling
    if (!+this.params.autoplay)
      $$.forEach($$("video"), function(v){ v.controls = true });
  }

  Dz.onkeydown = function(aEvent) {
    // Don't intercept keyboard shortcuts
    if (aEvent.altKey
      || aEvent.ctrlKey
      || aEvent.metaKey
      || aEvent.shiftKey) {
      return;
    }
    if ( aEvent.keyCode == 37 // left arrow
      || aEvent.keyCode == 38 // up arrow
      || aEvent.keyCode == 33 // page up
    ) {
      aEvent.preventDefault();
      this.back();
    }
    if ( aEvent.keyCode == 39 // right arrow
      || aEvent.keyCode == 40 // down arrow
      || aEvent.keyCode == 34 // page down
    ) {
      aEvent.preventDefault();
      this.forward();
    }
    if (aEvent.keyCode == 35) { // end
      aEvent.preventDefault();
      this.goEnd();
    }
    if (aEvent.keyCode == 36) { // home
      aEvent.preventDefault();
      this.goStart();
    }
    if (aEvent.keyCode == 32) { // space
      aEvent.preventDefault();
      this.toggleContent();
    }
    if (aEvent.keyCode == 70) { // f
      aEvent.preventDefault();
      this.goFullscreen();
    }
    if (aEvent.keyCode == 79) { // o
      aEvent.preventDefault();
      this.toggleView();
    }
  }

  /* Touch Events */

  Dz.setupTouchEvents = function() {
    var orgX, newX;
    var tracking = false;

    var db = document.body;
    db.addEventListener("touchstart", start.bind(this), false);
    db.addEventListener("touchmove", move.bind(this), false);

    function start(aEvent) {
      aEvent.preventDefault();
      tracking = true;
      orgX = aEvent.changedTouches[0].pageX;
    }

    function move(aEvent) {
      if (!tracking) return;
      newX = aEvent.changedTouches[0].pageX;
      if (orgX - newX > 100) {
        tracking = false;
        this.forward();
      } else {
        if (orgX - newX < -100) {
          tracking = false;
          this.back();
        }
      }
    }
  }

  Dz.setupView = function() {
    document.body.addEventListener("click", function ( e ) {
      if (!Dz.html.classList.contains("view")) return;
      if (!e.target || e.target.nodeName != "SECTION") return;

      Dz.html.classList.remove("view");
      Dz.setCursor(Dz.slides.indexOf(e.target) + 1);
    }, false);
  }

  /* Adapt the size of the slides to the window */

  Dz.onresize = function() {
    var db = document.body;
    var sx = db.clientWidth / window.innerWidth;
    var sy = db.clientHeight / window.innerHeight;
    var transform = "scale(" + (1/Math.max(sx, sy)) + ")";

    db.style.MozTransform = transform;
    db.style.WebkitTransform = transform;
    db.style.OTransform = transform;
    db.style.msTransform = transform;
    db.style.transform = transform;
  }


  Dz.getDetails = function(aIdx) {
    var s = $("section:nth-of-type(" + aIdx + ")");
    var d = s.$("details");
    return d ? d.innerHTML : "";
  }

  Dz.onmessage = function(aEvent) {
    var argv = aEvent.data.split(" "), argc = argv.length;
    argv.forEach(function(e, i, a) { a[i] = decodeURIComponent(e) });
    var win = aEvent.source;
    if (argv[0] === "REGISTER" && argc === 1) {
      this.remoteWindows.push(win);
      this.postMsg(win, "REGISTERED", document.title, this.slides.length);
      this.postMsg(win, "CURSOR", this.idx + "." + this.step);
      return;
    }
    if (argv[0] === "BACK" && argc === 1)
      this.back();
    if (argv[0] === "FORWARD" && argc === 1)
      this.forward();
    if (argv[0] === "START" && argc === 1)
      this.goStart();
    if (argv[0] === "END" && argc === 1)
      this.goEnd();
    if (argv[0] === "TOGGLE_CONTENT" && argc === 1)
      this.toggleContent();
    if (argv[0] === "SET_CURSOR" && argc === 2)
      window.location.hash = "#" + argv[1];
    if (argv[0] === "GET_CURSOR" && argc === 1)
      this.postMsg(win, "CURSOR", this.idx + "." + this.step);
    if (argv[0] === "GET_NOTES" && argc === 1)
      this.postMsg(win, "NOTES", this.getDetails(this.idx));
  }

  Dz.toggleContent = function() {
    // If a Video is present in this new slide, play it.
    // If a Video is present in the previous slide, stop it.
    var s = $("section[aria-selected]");
    if (s) {
      var video = s.$("video");
      if (video) {
        if (video.ended || video.paused) {
          video.play();
        } else {
          video.pause();
        }
      }
    }
  }

  Dz.setCursor = function(aIdx, aStep) {
    // If the user change the slide number in the URL bar, jump
    // to this slide.
    aStep = (aStep != 0 && typeof aStep !== "undefined") ? "." + aStep : ".0";
    window.location.hash = "#" + aIdx + aStep;
  }

  Dz.onhashchange = function() {
    var cursor = window.location.hash.split("#"),
        newidx = 1,
        newstep = 0;
    if (cursor.length == 2) {
      newidx = ~~cursor[1].split(".")[0];
      newstep = ~~cursor[1].split(".")[1];
      if (newstep > Dz.slides[newidx - 1].$$('.incremental > *').length) {
        newstep = 0;
        newidx++;
      }
    }
    this.setProgress(newidx, newstep);
    if (newidx != this.idx) {
      this.setSlide(newidx);
    }
    if (newstep != this.step) {
      this.setIncremental(newstep);
    }
    for (var i = 0; i < this.remoteWindows.length; i++) {
      this.postMsg(this.remoteWindows[i], "CURSOR", this.idx + "." + this.step);
    }
  }

  Dz.back = function() {
    if (this.idx == 1 && this.step == 0) {
      return;
    }
    if (this.step == 0) {
      this.setCursor(this.idx - 1,
                     this.slides[this.idx - 2].$$('.incremental > *').length);
    } else {
      this.setCursor(this.idx, this.step - 1);
    }
  }

  Dz.forward = function() {
    if (this.idx >= this.slides.length &&
        this.step >= this.slides[this.idx - 1].$$('.incremental > *').length) {
        return;
    }
    if (this.step >= this.slides[this.idx - 1].$$('.incremental > *').length) {
      this.setCursor(this.idx + 1, 0);
    } else {
      this.setCursor(this.idx, this.step + 1);
    }
  }

  Dz.goStart = function() {
    this.setCursor(1, 0);
  }

  Dz.goEnd = function() {
    var lastIdx = this.slides.length;
    var lastStep = this.slides[lastIdx - 1].$$('.incremental > *').length;
    this.setCursor(lastIdx, lastStep);
  }

  Dz.toggleView = function() {
    this.html.classList.toggle("view");

    if (this.html.classList.contains("view")) {
      $("section[aria-selected]").scrollIntoView(true);
    }
  }

  Dz.setSlide = function(aIdx) {
    this.idx = aIdx;
    var old = $("section[aria-selected]");
    var next = $("section:nth-of-type("+ this.idx +")");
    if (old) {
      old.removeAttribute("aria-selected");
      var video = old.$("video");
      if (video) {
        video.pause();
      }
    }
    if (next) {
      next.setAttribute("aria-selected", "true");
      if (this.html.classList.contains("view")) {
        next.scrollIntoView();
      }
      var video = next.$("video");
      if (video && !!+this.params.autoplay) {
        video.play();
      }
    } else {
      // That should not happen
      this.idx = -1;
      // console.warn("Slide doesn't exist.");
    }
  }

  Dz.setIncremental = function(aStep) {
    this.step = aStep;
    var old = this.slides[this.idx - 1].$('.incremental > *[aria-selected]');
    if (old) {
      old.removeAttribute('aria-selected');
    }
    var incrementals = $$('.incremental');
    if (this.step <= 0) {
      $$.forEach(incrementals, function(aNode) {
        aNode.removeAttribute('active');
      });
      return;
    }
    var next = this.slides[this.idx - 1].$$('.incremental > *')[this.step - 1];
    if (next) {
      next.setAttribute('aria-selected', true);
      next.parentNode.setAttribute('active', true);
      var found = false;
      $$.forEach(incrementals, function(aNode) {
        if (aNode != next.parentNode)
          if (found)
            aNode.removeAttribute('active');
          else
            aNode.setAttribute('active', true);
        else
          found = true;
      });
    } else {
      setCursor(this.idx, 0);
    }
    return next;
  }

  Dz.goFullscreen = function() {
    var html = $('html'),
        requestFullscreen = html.requestFullscreen || html.requestFullScreen || html.mozRequestFullScreen || html.webkitRequestFullScreen;
    if (requestFullscreen) {
      requestFullscreen.apply(html);
    }
  }

  Dz.setProgress = function(aIdx, aStep) {
    var slide = $("section:nth-of-type("+ aIdx +")");
    if (!slide)
      return;
    var steps = slide.$$('.incremental > *').length + 1,
        slideSize = 100 / (this.slides.length - 1),
        stepSize = slideSize / steps;
    this.progressBar.style.width = ((aIdx - 1) * slideSize + aStep * stepSize) + '%';
  }

  Dz.postMsg = function(aWin, aMsg) { // [arg0, [arg1...]]
    aMsg = [aMsg];
    for (var i = 2; i < arguments.length; i++)
      aMsg.push(encodeURIComponent(arguments[i]));
    aWin.postMessage(aMsg.join(" "), "*");
  }

  function init() {
    Dz.init();
    window.onkeydown = Dz.onkeydown.bind(Dz);
    window.onresize = Dz.onresize.bind(Dz);
    window.onhashchange = Dz.onhashchange.bind(Dz);
    window.onmessage = Dz.onmessage.bind(Dz);
  }

  window.onload = init;
</script>


<script> // Helpers
  if (!Function.prototype.bind) {
    Function.prototype.bind = function (oThis) {

      // closest thing possible to the ECMAScript 5 internal IsCallable
      // function
      if (typeof this !== "function")
      throw new TypeError(
        "Function.prototype.bind - what is trying to be fBound is not callable"
      );

      var aArgs = Array.prototype.slice.call(arguments, 1),
          fToBind = this,
          fNOP = function () {},
          fBound = function () {
            return fToBind.apply( this instanceof fNOP ? this : oThis || window,
                   aArgs.concat(Array.prototype.slice.call(arguments)));
          };

      fNOP.prototype = this.prototype;
      fBound.prototype = new fNOP();

      return fBound;
    };
  }

  var $ = (HTMLElement.prototype.$ = function(aQuery) {
    return this.querySelector(aQuery);
  }).bind(document);

  var $$ = (HTMLElement.prototype.$$ = function(aQuery) {
    return this.querySelectorAll(aQuery);
  }).bind(document);

  $$.forEach = function(nodeList, fun) {
    Array.prototype.forEach.call(nodeList, fun);
  }

</script>

